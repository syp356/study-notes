Eureka的使用与原理

##### 一. 在客户端配置文件中维护服务提供者的列表会带来什么问题？

1. 服务上线，下线(宕机)时，无法动态感知

2. 当服务过多的时候，服务调用者的维护工作会很困难

因此引入服务注册中心来维护服务列表

##### 二.  什么是服务注册中心？

1. 服务注册中心是服务实现服务化管理的核心组件,类似于目录服务的作用,主要用来存储服务信息,比如提供url串,路由信息等,服务注册中心是SOA架构中最基础的设施之一

##### 三.  如何实现一个服务注册中心？

1. 数据存储：持久化存储，内存存储

2. CAP模型：CP模型 (强一致性)|| AP模型（高可用性）

3. 注册中心如何感知服务的上下线，扩容和缩容：心跳检测

4. 客户端如何获取服务列表：

   4.1 pull：客户端定时轮询从注册中心获取服务列表， 注册中心不需要维护大量连接，但是会有数据延时问题

   4.2 push  当服务节点变化时，注册中心主动推送服务列表给客户端，客户端能够及时感知和更新服务节点变化，但是注册中心需要维护大量和客户端的连接

   4.3  long-pull  当客户端请求发送到注册中心时，注册中心先把请求hold住，当服务节点变化时，再进行回调，客户端需要监听回调接口，结合了pull和push的优点

5. api的提供形式：http协议  netty通信

###### 2.1 什么是CAP?

> CAP原则又称CAP定理，指的是在一个[分布式系统](https://baike.baidu.com/item/分布式系统/4905336)中， Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可得兼。
>
> 一致性（C）：在[分布式系统](https://baike.baidu.com/item/分布式系统/4905336)中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访问同一份最新的数据副本）
>
> 可用性（A）：在集群中一部分节点故障后，[集群](https://baike.baidu.com/item/集群/5486962)整体是否还能响应[客户端](https://baike.baidu.com/item/客户端/101081)的读写请求。（对数据更新具备高可用性）
>
> 分区容忍性（P）：以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况。而由于网络硬件肯定会出现延迟丢包等问题，所以分区容错性是我们必须需要实现的。所以我们只能在一致性和可用性之间进行权衡
>
> CAP原则的精髓就是要么AP，要么CP，要么AC，但是不存在CAP。如果在某个分布式系统中数据无副本， 那么系统必然满足强一致性条件， 因为只有独一数据，不会出现数据不一致的情况，此时C和P两要素具备，但是如果系统发生了网络分区状况或者宕机，必然导致某些数据不可以访问，此时可用性条件就不能被满足，即在此情况下获得了CP系统，但是CAP不可同时满足

##### 四. 常用的注册中心解决方案

Eureka：非持久化存储  内存存储 ap模型  集群节点角色是相等的

Consul：raft(redis-sentinel / nacos 选举)   long polling

Zookpeer：zab协议（paxos）  push

Etcd: raft  long polling

Nacos: raft  long polling

redis:

##### 六. Spring cloud Eureka

![image-20200909225905850](C:\Users\SYP\AppData\Roaming\Typora\typora-user-images\image-20200909225905850.png)

​	Netflix oss

​	Eureka Server

​	Eureka Client

三级缓存

###### 自我保护机制

减少网络抖动或者网络不稳定的情况下，避免误删除，心跳失败的比例在十五分钟内低于85%的节点，Eureka会认为出现了网络故障，从而启动自我保护机制。一般情况下，如果Eureka server 长时间未接收到某个节点的心跳，会直接踢出这个有问题的服务，启动自我保护机制后

1.不会提出因为长时间没有收到心跳数据的过期服务

2.仍然能够接收新的服务的注册和查询



kafka数据同步 高水位

zookeeper  过半提交 

Eureka 

Renews threshold

Renews(last min)